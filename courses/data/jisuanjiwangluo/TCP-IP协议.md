# TCP/IP协议

## 概述

TCP/IP（Transmission Control Protocol/Internet Protocol）是互联网的核心协议栈，定义了数据在网络中如何传输、路由和接收。它是一个四层模型，比OSI七层模型更实用和广泛应用。

## TCP/IP四层模型

### 1. 网络接口层（Network Interface Layer）
- 对应OSI的物理层和数据链路层
- 处理与物理网络的接口
- 包括硬件地址和物理传输

### 2. 网络层（Internet Layer）
- 对应OSI的网络层
- 主要协议：IP、ICMP、ARP
- 负责数据包的路由和转发

### 3. 传输层（Transport Layer）
- 对应OSI的传输层
- 主要协议：TCP、UDP
- 提供端到端的数据传输服务

### 4. 应用层（Application Layer）
- 对应OSI的会话层、表示层、应用层
- 包含各种应用协议
- 为用户应用提供网络服务

## IP协议（Internet Protocol）

### IPv4

**地址格式**：
- 32位地址，通常用点分十进制表示
- 例如：192.168.1.1
- 地址空间：约43亿个地址

**地址分类**：
- **A类**：1.0.0.0 - 126.255.255.255（/8）
- **B类**：128.0.0.0 - 191.255.255.255（/16）
- **C类**：192.0.0.0 - 223.255.255.255（/24）
- **D类**：224.0.0.0 - 239.255.255.255（组播）
- **E类**：240.0.0.0 - 255.255.255.255（保留）

**私有地址**：
- A类：10.0.0.0/8
- B类：172.16.0.0/12
- C类：192.168.0.0/16

**IPv4头部结构**：
```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### IPv6

**特点**：
- 128位地址空间
- 简化的头部格式
- 内置安全性（IPSec）
- 更好的QoS支持
- 无需NAT

**地址表示**：
- 使用冒号分隔的十六进制
- 例如：2001:0db8:85a3:0000:0000:8a2e:0370:7334
- 可简写为：2001:db8:85a3::8a2e:370:7334

## TCP协议（Transmission Control Protocol）

### 特点
- **面向连接**：通信前需建立连接
- **可靠传输**：保证数据完整性和顺序
- **流量控制**：防止发送方过快发送数据
- **拥塞控制**：避免网络拥塞
- **全双工通信**：双向数据传输

### TCP头部结构
```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### TCP连接管理

**三次握手（建立连接）**：
1. **SYN**：客户端发送SYN=1，seq=x
2. **SYN+ACK**：服务器发送SYN=1，ACK=1，seq=y，ack=x+1
3. **ACK**：客户端发送ACK=1，seq=x+1，ack=y+1

```
客户端                    服务器
   |                         |
   |-------SYN(seq=x)------->|
   |                         |
   |<--SYN+ACK(seq=y,ack=x+1)|
   |                         |
   |----ACK(seq=x+1,ack=y+1)->|
   |                         |
   |    连接建立完成          |
```

**四次挥手（关闭连接）**：
1. **FIN**：主动方发送FIN=1
2. **ACK**：被动方发送ACK确认
3. **FIN**：被动方发送FIN=1
4. **ACK**：主动方发送ACK确认

```
主动关闭方                被动关闭方
   |                         |
   |-------FIN(seq=u)------->|
   |                         |
   |<------ACK(ack=u+1)------|
   |                         |
   |<------FIN(seq=w)--------|
   |                         |
   |----ACK(ack=w+1)-------->|
   |                         |
   |    连接关闭完成          |
```

### TCP状态转换

**主要状态**：
- **CLOSED**：初始状态
- **LISTEN**：服务器等待连接
- **SYN_SENT**：客户端发送SYN后
- **SYN_RCVD**：服务器收到SYN后
- **ESTABLISHED**：连接建立
- **FIN_WAIT_1**：主动关闭，发送FIN后
- **FIN_WAIT_2**：收到ACK后
- **CLOSE_WAIT**：被动关闭，收到FIN后
- **LAST_ACK**：发送FIN后
- **TIME_WAIT**：主动关闭，等待2MSL

### TCP可靠性机制

**1. 序号和确认号**
- 每个字节都有序号
- 确认号表示期望收到的下一个字节

**2. 超时重传**
- 发送方设置重传定时器
- 超时未收到ACK则重传

**3. 快速重传**
- 收到3个重复ACK立即重传
- 不等待超时

**4. 流量控制**
- 使用滑动窗口机制
- 接收方通告窗口大小

**5. 拥塞控制**
- **慢启动**：指数增长
- **拥塞避免**：线性增长
- **快速恢复**：快速重传后的处理

## UDP协议（User Datagram Protocol）

### 特点
- **无连接**：不需要建立连接
- **不可靠**：不保证数据到达
- **简单高效**：开销小，速度快
- **支持广播和组播**

### UDP头部结构
```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            Length             |           Checksum            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### TCP vs UDP对比

| 特性 | TCP | UDP |
|------|-----|-----|
| 连接性 | 面向连接 | 无连接 |
| 可靠性 | 可靠 | 不可靠 |
| 速度 | 较慢 | 较快 |
| 头部开销 | 20字节 | 8字节 |
| 流量控制 | 有 | 无 |
| 拥塞控制 | 有 | 无 |
| 应用场景 | 文件传输、网页浏览、邮件 | 视频流、DNS、DHCP |

## 常用端口号

### 知名端口（0-1023）
- **20/21**：FTP（数据/控制）
- **22**：SSH
- **23**：Telnet
- **25**：SMTP
- **53**：DNS
- **67/68**：DHCP
- **80**：HTTP
- **110**：POP3
- **143**：IMAP
- **443**：HTTPS
- **993**：IMAPS
- **995**：POP3S

### 注册端口（1024-49151）
- **1433**：SQL Server
- **3306**：MySQL
- **3389**：RDP
- **5432**：PostgreSQL
- **8080**：HTTP代理

## 网络地址转换（NAT）

### NAT类型
1. **静态NAT**：一对一映射
2. **动态NAT**：多对多映射
3. **PAT（端口地址转换）**：多对一映射

### NAT工作原理
```
内网设备 → NAT设备 → 外网
192.168.1.100:1234 → 公网IP:5678 → 目标服务器
```

## 路由协议

### 内部网关协议（IGP）
- **RIP**：距离向量协议，最大跳数15
- **OSPF**：链路状态协议，支持VLSM
- **EIGRP**：思科私有协议

### 外部网关协议（EGP）
- **BGP**：边界网关协议，用于AS间路由

## 实际应用示例

### 网页访问过程
1. **DNS解析**：将域名转换为IP地址
2. **TCP连接**：与Web服务器建立连接
3. **HTTP请求**：发送GET请求
4. **数据传输**：接收网页内容
5. **连接关闭**：完成后关闭TCP连接

### 邮件发送过程
1. **SMTP连接**：与邮件服务器建立TCP连接
2. **身份验证**：用户名密码验证
3. **邮件传输**：发送邮件内容
4. **投递确认**：服务器确认接收

## 网络故障排除

### 常用命令
```bash
# 测试连通性
ping 8.8.8.8

# 跟踪路由
traceroute google.com

# 查看网络配置
ifconfig / ipconfig

# 查看路由表
route -n / route print

# 查看网络连接
netstat -an

# DNS查询
nslookup google.com
```

### 排查步骤
1. **物理连接**：检查网线、网卡
2. **IP配置**：检查IP地址、子网掩码、网关
3. **DNS设置**：检查DNS服务器配置
4. **路由表**：检查路由配置
5. **防火墙**：检查防火墙规则
6. **应用层**：检查应用程序配置

## 安全考虑

### 网络层安全
- **IPSec**：IP层加密
- **防火墙**：包过滤和状态检测
- **IDS/IPS**：入侵检测和防护

### 传输层安全
- **SSL/TLS**：传输层加密
- **端口安全**：关闭不必要的端口

### 应用层安全
- **HTTPS**：安全的HTTP
- **SFTP**：安全的文件传输
- **身份认证**：用户验证机制

## 性能优化

### TCP优化
- **窗口缩放**：支持大窗口
- **选择性确认**：SACK机制
- **时间戳选项**：精确RTT测量

### 网络优化
- **负载均衡**：分散流量
- **CDN**：内容分发网络
- **QoS**：服务质量保证