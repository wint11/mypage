<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>线性代数 - 无限习题链</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <style>
    body {
      background: linear-gradient(135deg, #e0f7fa, #fdfcfb);
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .question-block {
      max-width: 700px;
      margin: 50px auto;
      background-color: #fff;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .correct { color: green; }
    .incorrect { color: red; }
    #footer-container {
      margin-top: auto;
      padding: 20px;
      background-color: #f8f9fa;
      text-align: center;
      font-size: 0.9rem;
      color: #777;
    }
    #navigation-buttons {
      text-align: center;
      margin-bottom: 20px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(', '\\)'], ['$', '$']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <div id="navigation-buttons">
    <button class="btn btn-secondary me-2" id="prev-btn" disabled>上一题</button>
    <button class="btn btn-primary" id="next-btn" disabled>下一题</button>
  </div>
  <div id="exercise-container"></div>
  <div id="footer-container">© 2025 线性代数练习平台</div>

  <script>
    const apiKey = '6ce4c9b2-9d92-495c-a5f2-3a7ebff4098a';
    const model = 'doubao-1-5-pro-32k-250115';

    let exercises = JSON.parse(localStorage.getItem('exercises') || '[]');
    let currentIndex = exercises.length > 0 ? exercises.length - 1 : 0;
    let bufferedExercise = null;
    let answeredCorrect = false; // 当前题是否答对
    let isPreloading = false;

    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const container = document.getElementById("exercise-container");

    prevBtn.onclick = () => {
      if (currentIndex > 0) {
        currentIndex--;
        answeredCorrect = false;
        renderExercise(currentIndex);
        updateButtons();
      }
    };

    nextBtn.onclick = () => {
      if (!answeredCorrect) return; // 答错时不允许下一题

      if (currentIndex < exercises.length - 1) {
        currentIndex++;
        answeredCorrect = false;
        renderExercise(currentIndex);
        updateButtons();
        preloadNextExercise();
      } else if (bufferedExercise) {
        exercises.push(bufferedExercise);
        localStorage.setItem('exercises', JSON.stringify(exercises));
        bufferedExercise = null;
        currentIndex++;
        answeredCorrect = false;
        renderExercise(currentIndex);
        updateButtons();
        preloadNextExercise();
      } else {
        alert('下一题正在生成中，请稍候。');
        nextBtn.disabled = true;
      }
    };

    async function preloadNextExercise() {
      if (isPreloading || bufferedExercise) return;
      isPreloading = true;

      const prompt = `
请生成一道微分方程单选题，使用 markdown 格式，要求：
1. 题目用普通文本加LaTeX数学公式书写。
2. 选项用无序列表（- 选项文本）形式列出。
3. 答案请在末尾用 【正确答案：数字】 标明正确选项的序号（从0开始）。
4. 题目末尾请给出详细解析，解析用“解析:”开头。
`;
      try {
        const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [
              { role: "system", content: "你是一个微分方程题目生成器，请严格使用markdown的语法返回。" },
              { role: "user", content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 600
          })
        });

        const data = await response.json();
        bufferedExercise = data.choices?.[0]?.message?.content || null;
      } catch (e) {
        console.error('预加载失败：', e);
        bufferedExercise = null;
      } finally {
        isPreloading = false;
        updateButtons();
      }
    }

    function updateButtons() {
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = !answeredCorrect || 
        (currentIndex === exercises.length - 1 && !bufferedExercise);
    }

    function resetOptions(name) {
      const options = container.querySelectorAll(`input[name="${name}"]`);
      options.forEach(opt => {
        opt.disabled = false;
        opt.checked = false;
      });
    }

    function renderExercise(index) {
      const mdText = exercises[index];
      container.innerHTML = "";

      const block = document.createElement("div");
      block.className = "question-block";

      // 提取正确答案、解析、题干（除去答案和解析）
      const answerMatch = mdText.match(/【正确答案：(\d+)】/);
      const correctAnswerIndex = answerMatch ? parseInt(answerMatch[1], 10) : null;
      const explanationMatch = mdText.match(/解析:([\s\S]*)$/);
      const explanationMd = explanationMatch ? explanationMatch[1].trim() : "无解析";
      const mdWithoutAnswer = mdText.replace(/【正确答案：\d+】/, '').replace(/解析:[\s\S]*$/, '').trim();

      block.innerHTML = `<h5>题目 ${index + 1}：</h5>` + marked.parse(mdWithoutAnswer);

      // 提取选项
      const optionLines = mdWithoutAnswer.split('\n').filter(line => line.trim().startsWith('- '));
      const optionsDiv = document.createElement('div');

      optionLines.forEach((line, i) => {
        const optText = line.replace(/^- /, '').trim();
        const optId = `q${index}opt${i}`;

        const wrapper = document.createElement('div');
        wrapper.className = 'form-check';

        const input = document.createElement('input');
        input.className = 'form-check-input';
        input.type = 'radio';
        input.name = `q${index}`;
        input.id = optId;
        input.value = i;

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.setAttribute('for', optId);
        label.innerHTML = marked.parseInline(optText);

        wrapper.appendChild(input);
        wrapper.appendChild(label);
        optionsDiv.appendChild(wrapper);
      });

      block.appendChild(optionsDiv);

      // 操作按钮
      const checkBtn = document.createElement('button');
      checkBtn.className = "btn btn-outline-success mt-3";
      checkBtn.textContent = "检查答案";

      const redoBtn = document.createElement('button');
      redoBtn.className = "btn btn-outline-warning mt-3 ms-2";
      redoBtn.textContent = "再做一次";
      redoBtn.style.display = "none";

      const resetBtn = document.createElement('button');
      resetBtn.className = "btn btn-outline-secondary mt-3 ms-2";
      resetBtn.textContent = "重新选择";
      resetBtn.style.display = "none";

      const viewExplanationBtn = document.createElement('button');
      viewExplanationBtn.className = "btn btn-outline-info mt-3 ms-2";
      viewExplanationBtn.textContent = "查看解析";
      viewExplanationBtn.style.display = "none";

      const explanationDiv = document.createElement('div');
      explanationDiv.className = 'mt-3';
      explanationDiv.style.display = 'none';

      checkBtn.onclick = () => {
        const selected = block.querySelector(`input[name="q${index}"]:checked`);
        if (!selected) {
          alert("请选择一个选项！");
          return;
        }

        const userChoice = parseInt(selected.value, 10);
        const isCorrect = userChoice === correctAnswerIndex;

        let resultDiv = block.querySelector('.result-message');
        if (!resultDiv) {
          resultDiv = document.createElement('div');
          resultDiv.className = 'result-message mt-3';
          block.appendChild(resultDiv);
        }
        resultDiv.className = isCorrect ? 'correct mt-3 result-message' : 'incorrect mt-3 result-message';
        resultDiv.textContent = isCorrect ? "✅ 正确" : "❌ 错误";

        viewExplanationBtn.style.display = 'inline-block';
        checkBtn.disabled = true;

        block.querySelectorAll('input[name="q' + index + '"]').forEach(i => i.disabled = true);

        answeredCorrect = isCorrect;
        updateButtons();

        if (!isCorrect) {
          redoBtn.style.display = 'inline-block';
          resetBtn.style.display = 'inline-block';
        } else {
          redoBtn.style.display = 'none';
          resetBtn.style.display = 'none';
        }
      };

      redoBtn.onclick = () => {
        answeredCorrect = false;
        updateButtons();

        resetOptions(`q${index}`);
        checkBtn.disabled = false;

        const resultDiv = block.querySelector('.result-message');
        if (resultDiv) resultDiv.remove();

        redoBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        viewExplanationBtn.style.display = 'none';
        explanationDiv.style.display = 'none';
      };

      resetBtn.onclick = () => {
        resetOptions(`q${index}`);
        checkBtn.disabled = false;
        redoBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        viewExplanationBtn.style.display = 'none';
        explanationDiv.style.display = 'none';

        const resultDiv = block.querySelector('.result-message');
        if (resultDiv) resultDiv.remove();
      };

      viewExplanationBtn.onclick = () => {
        if (explanationDiv.style.display === 'none') {
          explanationDiv.innerHTML = "<strong>解析：</strong>" + marked.parse(explanationMd);
          explanationDiv.style.display = 'block';
          viewExplanationBtn.textContent = "收起解析";
        } else {
          explanationDiv.style.display = 'none';
          viewExplanationBtn.textContent = "查看解析";
        }
      };

      block.appendChild(checkBtn);
      block.appendChild(redoBtn);
      block.appendChild(resetBtn);
      block.appendChild(viewExplanationBtn);
      block.appendChild(explanationDiv);

      container.appendChild(block);

      // 重新渲染数学公式
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetClear();
        MathJax.typesetPromise();
      }
    }

    async function init() {
      if (exercises.length === 0) {
        await preloadNextExercise();
        if (bufferedExercise) {
          exercises.push(bufferedExercise);
          bufferedExercise = null;
          localStorage.setItem('exercises', JSON.stringify(exercises));
        }
      }
      renderExercise(currentIndex);
      updateButtons();
      preloadNextExercise();
    }

    init();
  </script>
</body>
</html>
