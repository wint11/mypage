<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFæ¸²æŸ“å™¨ - æ¨¡å—åŒ–ç‰ˆæœ¬</title>
    
    <!-- DNSé¢„è§£æå’Œé¢„è¿æ¥ä¼˜åŒ– -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- é¢„åŠ è½½å…³é”®CSS -->
    <link rel="preload" href="css/pdf-renderer.css" as="style">
    <link rel="stylesheet" href="css/pdf-renderer.css">
    
    <!-- èµ„æºåŠ è½½ç®¡ç†å™¨ -->
    <script>
        window.ResourceLoader = {
            loadedResources: new Set(),
            failedResources: new Set(),
            totalResources: 5, // MathJaxé…ç½® + MathJax + html2pdf + Marked + åº”ç”¨åˆå§‹åŒ–
            loadedCount: 0,
            
            // CDNå¤‡ç”¨æ–¹æ¡ˆ
            cdnSources: {
                mathjax: [
                    '../js/tex-mml-chtml.js',
                    'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js',
                    'https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js'
                ],
                html2pdf: [
                    '../js/html2pdf.bundle.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js',
                    'https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js'
                ],
                marked: [
                    '../js/marked.min.js',
                    'https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js',
                    'https://unpkg.com/marked@4.3.0/marked.min.js'
                ]
            },
            
            updateProgress: function(message) {
                const progressFill = document.getElementById('progressFill');
                const loadingStatus = document.getElementById('loadingStatus');
                const percentage = Math.round((this.loadedCount / this.totalResources) * 100);
                
                if (progressFill) progressFill.style.width = percentage + '%';
                if (loadingStatus) loadingStatus.textContent = message;
            },
            
            markLoaded: function(resourceName) {
                this.loadedResources.add(resourceName);
                this.loadedCount++;
                this.updateProgress(`å·²åŠ è½½ ${resourceName} (${this.loadedCount}/${this.totalResources})`);
                
                if (this.loadedCount >= this.totalResources) {
                    this.hideLoading();
                }
            },
            
            loadScript: function(src, resourceName, fallbackIndex = 0) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    const sources = this.cdnSources[resourceName] || [src];
                    const currentSrc = sources[fallbackIndex] || src;
                    
                    script.src = currentSrc;
                    script.async = true;
                    
                    const timeout = setTimeout(() => {
                        script.remove();
                        if (fallbackIndex < sources.length - 1) {
                            console.warn(`${resourceName} åŠ è½½è¶…æ—¶ï¼Œå°è¯•å¤‡ç”¨æº: ${sources[fallbackIndex + 1]}`);
                            this.updateProgress(`${resourceName} åŠ è½½è¶…æ—¶ï¼Œå°è¯•å¤‡ç”¨æº...`);
                            this.loadScript(src, resourceName, fallbackIndex + 1).then(resolve).catch(reject);
                        } else {
                            this.failedResources.add(resourceName);
                            reject(new Error(`æ‰€æœ‰ ${resourceName} æºéƒ½åŠ è½½å¤±è´¥`));
                        }
                    }, 10000); // 10ç§’è¶…æ—¶
                    
                    script.onload = () => {
                        clearTimeout(timeout);
                        this.markLoaded(resourceName);
                        resolve();
                    };
                    
                    script.onerror = () => {
                        clearTimeout(timeout);
                        script.remove();
                        if (fallbackIndex < sources.length - 1) {
                            console.warn(`${resourceName} åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº: ${sources[fallbackIndex + 1]}`);
                            this.updateProgress(`${resourceName} åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº...`);
                            this.loadScript(src, resourceName, fallbackIndex + 1).then(resolve).catch(reject);
                        } else {
                            this.failedResources.add(resourceName);
                            reject(new Error(`æ‰€æœ‰ ${resourceName} æºéƒ½åŠ è½½å¤±è´¥`));
                        }
                    };
                    
                    document.head.appendChild(script);
                });
            },
            
            hideLoading: function() {
                setTimeout(() => {
                    const overlay = document.getElementById('loadingOverlay');
                    const container = document.getElementById('mainContainer');
                    
                    if (overlay) {
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.style.display = 'none', 500);
                    }
                    
                    if (container) {
                        container.style.display = 'block';
                        setTimeout(() => container.style.opacity = '1', 100);
                    }
                }, 500);
            }
        };
    </script>
    
    <!-- MathJaxé…ç½®å¿…é¡»åœ¨MathJaxåº“åŠ è½½ä¹‹å‰ -->
    <script src="js/mathjax-config.js" onload="ResourceLoader.markLoaded('MathJaxé…ç½®')" onerror="ResourceLoader.markLoaded('MathJaxé…ç½®')"></script>
    
    <!-- ä½¿ç”¨èµ„æºåŠ è½½å™¨åŠ è½½åº“æ–‡ä»¶ -->
    <script>
        // å¼€å§‹åŠ è½½èµ„æº
        ResourceLoader.updateProgress('å¼€å§‹åŠ è½½èµ„æº...');
        
        // åŠ è½½MathJax
        ResourceLoader.loadScript('../js/tex-mml-chtml.js', 'mathjax').catch(console.error);
        
        // åŠ è½½html2pdf
        ResourceLoader.loadScript('../js/html2pdf.bundle.min.js', 'html2pdf').catch(console.error);
        
        // åŠ è½½Marked
        ResourceLoader.loadScript('../js/marked.min.js', 'marked').catch(console.error);
    </script>
</head>
<body>
    <!-- åŠ è½½çŠ¶æ€è¦†ç›–å±‚ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">æ­£åœ¨åŠ è½½PDFæ¸²æŸ“å™¨...</div>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="loadingStatus" class="loading-status">åˆå§‹åŒ–ä¸­...</div>
            </div>
            <div class="loading-tips">
                <p>ğŸ’¡ å°è´´å£«ï¼šé¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´</p>
                <p>ğŸ”„ å¦‚æœåŠ è½½æ—¶é—´è¿‡é•¿ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•å¤‡ç”¨èµ„æº</p>
            </div>
        </div>
    </div>

    <div class="container" style="display: none;" id="mainContainer">
        <h1>ğŸ“„ PDFæ¸²æŸ“å™¨å·¥å…·</h1>
        
        <!-- æ ‡å‡†è¾“å…¥åŒºåŸŸ -->
        <div class="control-panel">
            <h3>ğŸ“ æ ‡å‡†è¾“å…¥åŒºåŸŸ</h3>
            <p>æ”¯æŒæ ‡å‡†Markdownå’ŒLaTeXè¯­æ³•ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºæ¸²æŸ“å™¨æ ¼å¼</p>
            <textarea id="userFriendlyInput" class="json-input" placeholder="åœ¨æ­¤è¾“å…¥æ ‡å‡†çš„Markdownå’ŒLaTeXå†…å®¹..."></textarea>
            <div class="button-group">
                <button class="render-button" id="convertButton">ğŸ”„ è½¬æ¢å¹¶æ¸²æŸ“</button>
                <button class="render-button copy-button" id="copyConvertedButton">ğŸ“‹ å¤åˆ¶è½¬æ¢ç»“æœ</button>
            </div>
        </div>

        <!-- é«˜çº§è¾“å…¥åŒºåŸŸ -->
        <div class="control-panel">
            <h3>âš™ï¸ é«˜çº§è¾“å…¥åŒºåŸŸ (JSONæ ¼å¼)</h3>
            <p>ç›´æ¥è¾“å…¥JSONæ ¼å¼æ•°æ®ï¼Œæ”¯æŒå¤æ‚çš„æ–‡æ¡£ç»“æ„</p>
            <textarea id="jsonInput" class="json-input" placeholder='{
  "title": "æ–‡æ¡£æ ‡é¢˜",
  "context": "Markdownå†…å®¹...",
  "author": "ä½œè€…",
  "timestamp": "æ—¶é—´æˆ³"
}'></textarea>
            <div class="button-group">
                <button class="render-button" id="renderButton">ğŸš€ æ¸²æŸ“å†…å®¹</button>
                <button class="pdf-button" id="pdfButton" disabled>ğŸ“„ ç”ŸæˆPDFä¸‹è½½</button>
            </div>
        </div>

        <!-- è¾“å‡ºåŒºåŸŸ -->
        <div class="output-section">
            <div class="output-title">ğŸ¨ æ¸²æŸ“ç»“æœ</div>
            <div id="output" class="rendered-content"></div>

            <div class="output-title">ğŸ“Š è§£æä¿¡æ¯</div>
            <div id="parseInfo" class="rendered-content"></div>
        </div>
    </div>

    <!-- å¼•å…¥æ¨¡å—åŒ–çš„JavaScriptæ–‡ä»¶ï¼Œä½¿ç”¨deferä¼˜åŒ–åŠ è½½ -->
    <script src="js/markdown-processor.js" defer></script>
    <script src="js/pdf-generator.js" defer></script>
    <script src="js/ui-controller.js" defer></script>
    <script src="js/app-controller.js" defer></script>
</body>
</html>